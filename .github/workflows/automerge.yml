name: Automerge PRs
on:
  pull_request_target:
    branches: [ main ]
    types: [ opened ]
jobs:
  enableAutoMerge:
    runs-on: ubuntu-latest
    if: github.event.pull_request.user.login == 'dependabot[bot]'
    steps:
      - uses: actions/checkout@v2
      - name: Authenticate via APP
        id: authentication
        uses: ./
        with:
          appId: ${{ secrets.APP_ID }}
          clientId: ${{ secrets.CLIENT_ID }}
          clientSecret: ${{ secrets.CLIENT_SECRET }}
          privateKey: ${{ secrets.PRIVATE_KEY }}
          installationId: ${{ secrets.INSTALLATION_ID }}
      - uses: octokit/graphql-action@v2.x
        id: get_pull_request_id
        env:
          GITHUB_TOKEN: ${{ steps.authentication.outputs.token }}
        with:
          query: |
            query GetPullRequest($owner:String!,$repository:String!,$pull_request_number:Int!) {
              repository(owner:$owner,name:$repository) {
                pullRequest(number:$pull_request_number) {
                  id
                }
              }
            }
          owner: ${{ github.event.repository.owner.login }}
          repository: ${{ github.event.repository.name }}
          pull_request_number: ${{ github.event.pull_request.number }}
      - uses: octokit/graphql-action@v2.x
        id: enable_automerge
        env:
          GITHUB_TOKEN: ${{ steps.authentication.outputs.token }}
        with:
          query: |
            mutation EnableAutomerge($pull_request_id:String!) {
              addComment(input: {
                subjectId: $pull_request_id,
                body: "@dependabot merge"
              }) {
                __typename
              }
            }
          pull_request_id: ${{ fromJson(steps.get_pull_request_id.outputs.data).repository.pullRequest.id }}
